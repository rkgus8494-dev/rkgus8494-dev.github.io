<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ±âœ¨ ì†Œë¹„ìš”ì •ì˜ ë¸Œë ˆì´í¬ ë§ˆë²•</title>
  <style>
    :root{
      --pink:#ff4f87; --lav:#c76bff; --bg1:#fff0f6; --bg2:#f5e9ff;
      --card:#fff; --line:#ffe0ef; --text:#3a3a3a; --muted:#777;
      --ok:#1f8f50; --bad:#ff4f87;
      font-family:"Apple SD Gothic Neo",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans KR",sans-serif;
    }
    body{margin:0;color:var(--text);background:linear-gradient(135deg,var(--bg1),var(--bg2));min-height:100vh;}
    .wrap{max-width:980px;margin:0 auto;padding:20px;}
    .card{background:var(--card);border-radius:28px;box-shadow:0 16px 44px rgba(255,79,135,.16);padding:22px;border:1px solid rgba(255,224,239,.9);}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{width:46px;height:46px;border-radius:18px;background:radial-gradient(circle at 30% 30%,#fff,#ffe4f2 45%,#fce4ff);border:1px solid var(--line);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 26px rgba(255,79,135,.14);user-select:none;font-size:22px;}
    h1{margin:0;font-size:22px;line-height:1.15;color:var(--pink);}
    .sub{margin-top:2px;font-size:13px;color:var(--muted);}
    .cta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;}
    .btn{border:0;cursor:pointer;border-radius:18px;padding:12px 14px;font-weight:900;color:#fff;background:linear-gradient(135deg,var(--pink),var(--lav));box-shadow:0 12px 30px rgba(199,107,255,.18);transition:transform .15s ease;text-decoration:none;display:inline-flex;align-items:center;gap:8px;user-select:none;}
    .btn:hover{transform:translateY(-1px) scale(1.02);}
    .btn.ghost{background:#fff;color:var(--pink);border:1px solid var(--line);box-shadow:none;}
    .bubble{margin-top:14px;background:#ffe4f2;border:1px solid var(--line);border-radius:22px;padding:12px 14px;box-shadow:0 10px 26px rgba(255,79,135,.12);display:flex;gap:10px;align-items:flex-start;}
    .bubble .cat{width:38px;height:38px;border-radius:16px;background:#fff;border:1px solid var(--line);display:flex;align-items:center;justify-content:center;font-size:20px;flex:0 0 auto;}
    .bubble .text{font-size:14px;color:#555;line-height:1.35;}
    .tabs{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:16px 0 8px;}
    .tab{border:0;background:#fce4ff;color:#b85fc6;padding:10px 16px;border-radius:999px;font-weight:900;cursor:pointer;transition:.15s ease;user-select:none;}
    .tab.active{background:var(--pink);color:#fff;}
    .section-title{font-size:16px;margin:16px 0 8px;color:#4a4a4a;}
    .muted{color:var(--muted);font-size:12px;line-height:1.35;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:720px){.row{grid-template-columns:1fr}.cta{justify-content:flex-start}}
    label{display:block;font-size:12px;color:#444;margin:10px 0 6px;font-weight:700;}
    input,select{width:100%;padding:11px 12px;border-radius:16px;border:1px solid var(--line);background:#fff9fc;font-size:14px;outline:none;}
    input:focus,select:focus{border-color:rgba(255,79,135,.55);box-shadow:0 0 0 3px rgba(255,79,135,.12);}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px;}
    @media (max-width:720px){.kpis{grid-template-columns:1fr}}
    .kpi{background:#fff;border:1px solid var(--line);border-radius:18px;padding:12px;}
    .kpi .k{color:var(--muted);font-size:12px;font-weight:700;}
    .kpi .v{margin-top:6px;font-size:18px;font-weight:900;color:#333;}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;font-weight:900;color:var(--pink);}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:#fff;border-radius:18px;overflow:hidden;border:1px solid var(--line);}
    th,td{padding:10px;border-bottom:1px solid rgba(255,224,239,.8);font-size:13px;vertical-align:top;}
    th{text-align:left;color:#666;font-size:12px;background:#fff5fb;}
    tr:last-child td{border-bottom:0;}
    .right{text-align:right;}
    .danger{color:var(--bad);font-weight:900;}
    .ok{color:var(--ok);font-weight:900;}
    .note{background:#faf6ff;border:1px dashed rgba(199,107,255,.35);border-radius:18px;padding:12px;color:#555;font-size:13px;line-height:1.4;}
    .fairy-toast{position:sticky;top:12px;z-index:50;margin:0 auto 14px;max-width:860px;background:rgba(255,255,255,.92);border:1px solid var(--line);border-radius:18px;padding:12px 14px;box-shadow:0 10px 26px rgba(255,79,135,.15);backdrop-filter:blur(8px);}
    .fairy-toast-title{font-weight:900;color:var(--pink);margin-bottom:4px;font-size:13px;}
    .fairy-toast-msg{color:#555;font-size:14px;line-height:1.35;}
    .footer{margin-top:14px;text-align:center;font-size:12px;color:#888;}
    .lock{background:rgba(255,255,255,.88);border:1px solid var(--line);border-radius:22px;padding:14px;margin-top:10px;}
    /* print (ë¬´ë£ŒëŠ” ë²„íŠ¼ ì ê¸ˆì´ë¼ í° ì˜ë¯¸ ì—†ìŒ) */
    @media print{
      body{background:#fff;}
      .tabs,.cta,.bubble,.footer,#fairyToast{display:none !important;}
      .card{box-shadow:none;border:0;}
      .wrap{padding:0;max-width:none;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="fairyToast" class="fairy-toast" style="display:none;">
      <div class="fairy-toast-title">ğŸ± ì†Œë¹„ìš”ì • ì•Œë¦¼</div>
      <div id="fairyToastMsg" class="fairy-toast-msg"></div>
    </div>

    <div class="card">
      <div class="topbar">
        <div class="brand">
          <div class="logo">ğŸ±</div>
          <div>
            <h1>ğŸ±âœ¨ ì†Œë¹„ìš”ì •ì˜ ë¸Œë ˆì´í¬ ë§ˆë²•</h1>
            <div class="sub">ğŸ’– ê³µì£¼ë‹˜ì˜ ì¶©ë™ ì†Œë¹„ë¥¼ ë§‰ì•„ë“œë ¤ìš” Â· ê²°ì œ ì „ì— í›„íšŒ í™•ë¥ ë¶€í„° í™•ì¸!</div>
          </div>
        </div>
        <div class="cta">
          <a class="btn" id="payBtn" href="#" target="_blank" rel="noreferrer">ğŸ‘‘ í”„ë¦¬ë¯¸ì—„ 4,900ì›</a>
          <button class="btn ghost" id="resetAll" type="button">ğŸ§¼ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="bubble">
        <div class="cat">ğŸ¾</div>
        <div class="text"><b>ì†Œë¹„ìš”ì •</b>: â€œê³µì£¼ë‹˜â€¦ ê²°ì œ ì „ì— <b>10ì´ˆ ì²´í¬</b>ë§Œ í•´ë„ í›„íšŒê°€ ì¤„ì–´ë“¤ì–´ìš”!â€</div>
      </div>

      <div class="tabs">
        <button class="tab active" type="button" data-tab="diagnosis">âœ¨ ì§„ë‹¨</button>
        <button class="tab" type="button" data-tab="log">ğŸ§¾ ê¸°ë¡</button>
        <button class="tab" type="button" data-tab="report">ğŸ“Š ë¦¬í¬íŠ¸</button>
        <button class="tab" type="button" data-tab="check">â± 10ì´ˆ ì²´í¬(í”„ë¦¬ë¯¸ì—„)</button>
      </div>

      <section id="diagnosis">
        <div class="section-title">âœ¨ ì¶©ë™ ì†Œë¹„ ì§„ë‹¨</div>
        <div class="muted">ê°„ë‹¨íˆ ì„±í–¥ì„ í™•ì¸í•˜ê³ , ê¸°ë¡/ë¦¬í¬íŠ¸ë¡œ íŒ¨í„´ì„ ì¡ì•„ë³´ì„¸ìš”.</div>
        <div id="qList"></div>
        <div class="actions">
          <button class="btn" id="calcType" type="button">ğŸ± ê²°ê³¼ ë³´ê¸°</button>
        </div>
        <div id="typeResult" style="margin-top:12px;"></div>
      </section>

      <section id="log" style="display:none;">
        <div class="section-title">ğŸ§¾ ì†Œë¹„ ê¸°ë¡</div>
        <div class="muted">í›„íšŒ ì ìˆ˜ = (5-ë§Œì¡±ë„)+(5-í•„ìš”ë„). <b>6 ì´ìƒ</b>ì´ë©´ â€œí›„íšŒ ê°€ëŠ¥ì„± ë†’ìŒâ€.</div>

        <div class="row">
          <div><label>ë‚ ì§œ</label><input id="dDate" type="date" /></div>
          <div><label>í•­ëª©</label><input id="dItem" placeholder="ì˜ˆ: ë°°ë‹¬, ì»¤í”¼, ë¦½ìŠ¤í‹±" /></div>
        </div>
        <div class="row">
          <div><label>ê¸ˆì•¡(ì›)</label><input id="dAmount" type="number" min="0" step="100" placeholder="ì˜ˆ: 12900" /></div>
          <div><label>ì¹´í…Œê³ ë¦¬</label>
            <select id="dCategory">
              <option value="ì‹ë¹„">ì‹ë¹„</option><option value="ì¹´í˜/ê°„ì‹">ì¹´í˜/ê°„ì‹</option><option value="êµí†µ">êµí†µ</option>
              <option value="ì‡¼í•‘">ì‡¼í•‘</option><option value="ìƒí™œ">ìƒí™œ</option><option value="ê±´ê°•">ê±´ê°•</option>
              <option value="êµ¬ë…">êµ¬ë…</option><option value="ê¸°íƒ€" selected>ê¸°íƒ€</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div><label>ê°ì •</label>
            <select id="dEmotion">
              <option value="ìŠ¤íŠ¸ë ˆìŠ¤">ìŠ¤íŠ¸ë ˆìŠ¤</option><option value="ì§€ë£¨í•¨">ì§€ë£¨í•¨</option><option value="ì„¤ë ˜">ì„¤ë ˜</option>
              <option value="ë³´ìƒ">ë³´ìƒ</option><option value="ë¹„êµ">ë¹„êµ</option><option value="í•„ìš”">í•„ìš”</option><option value="ìŠµê´€">ìŠµê´€</option>
            </select>
          </div>
          <div><label>ë§Œì¡±ë„ (1~5)</label>
            <select id="dSatis"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select>
          </div>
        </div>
        <div class="row">
          <div><label>í•„ìš”ë„ (1~5)</label>
            <select id="dNeed"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select>
          </div>
          <div></div>
        </div>

        <div class="actions">
          <button class="btn" id="addRow" type="button">â• ê¸°ë¡ ì¶”ê°€</button>
          <button class="btn ghost" id="clearLogs" type="button">ğŸ—‘ ê¸°ë¡ ì „ì²´ ì‚­ì œ</button>
        </div>

        <div class="section-title" style="margin-top:18px;">ğŸ“Œ ê¸°ë¡ ëª©ë¡</div>
        <div style="overflow:auto;">
          <table>
            <thead><tr><th>ë‚ ì§œ</th><th>í•­ëª©</th><th class="right">ê¸ˆì•¡</th><th>ì¹´í…Œê³ ë¦¬</th><th>ê°ì •</th><th>ë§Œì¡±/í•„ìš”</th><th>í›„íšŒ</th><th></th></tr></thead>
            <tbody id="logTbody"></tbody>
          </table>
        </div>
      </section>

      <section id="report" style="display:none;">
        <div class="section-title">ğŸ“Š ì´ë²ˆ ë‹¬ í›„íšŒ ë¦¬í¬íŠ¸</div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label>ë¦¬í¬íŠ¸ ì›”</label>
            <select id="monthSelect"></select>
            <div class="muted">ê¸°ë³¸ì€ ì´ë²ˆ ë‹¬ì´ì—ìš”.</div>
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap;">
            <button class="btn ghost" id="btnDownloadCsv" type="button" style="width:auto;">â¬‡ CSV</button>
            <button class="btn ghost" id="btnSavePdf" type="button" style="width:auto;">ğŸ–¨ ë¦¬í¬íŠ¸ PDF(í”„ë¦¬ë¯¸ì—„)</button>
          </div>
        </div>

        <div class="kpis" id="kpis"></div>

        <div class="section-title">ğŸ¾ ê°ì • TOP</div>
        <div id="emotionTop" class="note">ê¸°ë¡ì„ ì¶”ê°€í•˜ë©´ ë¶„ì„ë¼ìš”.</div>

        <div class="section-title">ğŸ€ ì¹´í…Œê³ ë¦¬ TOP</div>
        <div id="categoryTop" class="note">ê¸°ë¡ì„ ì¶”ê°€í•˜ë©´ ë¶„ì„ë¼ìš”.</div>

        <div class="section-title">ğŸ‘‘ ë‹¤ìŒ ë‹¬ ì „ëµ</div>
        <div id="strategy" class="note"></div>

        <div class="lock" id="premiumUpsell">
          <div style="font-weight:900;color:var(--pink);margin-bottom:6px;">ğŸ‘‘ í”„ë¦¬ë¯¸ì—„ ê¸°ëŠ¥</div>
          <div class="muted" style="margin-bottom:10px;">
            âœ” ê²°ì œ ì „ 10ì´ˆ ì²´í¬(ì¦‰ì‹œ ì°¨ë‹¨)<br>
            âœ” ì˜ˆìœ ì›”ê°„ ë¦¬í¬íŠ¸ PDF ì €ì¥
          </div>
          <a class="btn" id="payBtn2" href="#" target="_blank" rel="noreferrer">í”„ë¦¬ë¯¸ì—„ ì—´ê¸° 4,900ì›</a>
        </div>
      </section>

      <section id="check" style="display:none;">
        <div class="section-title">â± ê²°ì œ ì „ 10ì´ˆ ì²´í¬ (í”„ë¦¬ë¯¸ì—„)</div>
        <div class="note">
          ì´ ê¸°ëŠ¥ì€ <b>í”„ë¦¬ë¯¸ì—„ ì „ìš©</b>ì´ì—ìš”.<br>
          â€œê²°ì œí•˜ê¸°â€ ëˆ„ë¥´ê¸° ì „ì— 4ë¬¸í•­ë§Œ ì²´í¬í•˜ë©´ ì†Œë¹„ìš”ì •ì´ <b>GO / WAIT / STOP</b>ë¡œ íŒì •í•´ë“œë ¤ìš”.
          <div style="margin-top:10px;">
            <a class="btn" id="payBtn3" href="#" target="_blank" rel="noreferrer">ğŸ‘‘ í”„ë¦¬ë¯¸ì—„ ì—´ê¸° 4,900ì›</a>
          </div>
        </div>
      </section>

      <div class="footer">ğŸ±âœ¨ â€œê³µì£¼ë‹˜, ëˆì€ ê³µì£¼ë‹˜ì˜ í¸ì´ì—ìš”.â€</div>
    </div>
  </div>

<script>
  // ====== ì„¤ì •(ë¬´ë£Œ) ======
  const IS_PREMIUM = false;
  const PAY_LINK = "https://ì—¬ê¸°ì—_í¬ë¦¬ì—ì´í„°ë§í¬_ê²°ì œURL"; // âœ… ì—¬ê¸°ë§Œ ë°”ê¾¸ê¸°

  // ===== storage =====
  const KEY = "spend_fairy_v2_free";
  const state = load() ?? { answers: Array(10).fill(3), logs: [], uiMonth: "" };

  function load(){ try { return JSON.parse(localStorage.getItem(KEY)); } catch { return null; } }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  const $ = (id)=>document.getElementById(id);

  // links
  ["payBtn","payBtn2","payBtn3"].forEach(id=>{ const el=$(id); if(el) el.href = PAY_LINK; });

  const today = new Date();
  const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);

  function formatWon(n){ try { return Number(n).toLocaleString("ko-KR")+"ì›"; } catch { return n+"ì›"; } }
  function escapeHtml(s){ return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  function regretScore(satis, need){ return (5-Number(satis)) + (5-Number(need)); }
  function getYYYYMM(dateStr){ return (dateStr && dateStr.length>=7) ? dateStr.slice(0,7) : ""; }

  // toast
  let toastTimer=null;
  function showFairyToast(message){
    const box=$("fairyToast"), msg=$("fairyToastMsg");
    if(!box||!msg) return;
    msg.innerHTML=message;
    box.style.display="block";
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>{box.style.display="none";},3600);
  }

  function fairyCommentByScore(score, category, emotion){
    if(score>=8) return `ğŸš¨ ê³µì£¼ë‹˜!!! <b>í›„íšŒ ì ìˆ˜ ${score}</b> ğŸ’”<br>48ì‹œê°„ ë³´ë¥˜í•˜ê³  ë‚´ì¼ ë‹¤ì‹œ ë´ìš”!`;
    if(score>=6) return `âš ï¸ ê³µì£¼ë‹˜ ì ê¹! <b>í›„íšŒ ì ìˆ˜ ${score}</b><br><span class="pill">${escapeHtml(category)}</span> + <span class="pill">${escapeHtml(emotion)}</span> ì¡°í•©ì´ë©´ ì¶©ë™ í™•ë¥ â†‘ ğŸ¾`;
    if(score<=2) return `ğŸ‘‘ ì˜¤ëŠ˜ í†µì œë ¥ ë§Œë ™! <b>í›„íšŒ ì ìˆ˜ ${score}</b> âœ…<br>ìš”ì •ì´ ë°•ìˆ˜ì¹˜ê³  ìˆì–´ìš” ğŸ‘ğŸ±âœ¨`;
    return `ğŸ± â€œë‚˜ì˜ì§€ ì•Šì•„ìš” ê³µì£¼ë‹˜!â€ <b>í›„íšŒ ì ìˆ˜ ${score}</b> ğŸ’—`;
  }

  // tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const tab=btn.dataset.tab;
      ["diagnosis","log","report","check"].forEach(id=>{ document.getElementById(id).style.display = (id===tab)?"block":"none"; });
      if(tab==="log") renderLogs();
      if(tab==="report") renderReport();
      if(tab==="check") showFairyToast("ğŸ”’ 10ì´ˆ ì²´í¬ëŠ” í”„ë¦¬ë¯¸ì—„ ì „ìš©ì´ì—ìš”, ê³µì£¼ë‹˜!");
    });
  });

  // diagnosis questions
  const questions = [
    { text:"ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ìœ¼ë©´ ì†Œë¹„ë¡œ ê¸°ë¶„ì„ í‘¼ë‹¤.", map:{R:1,E:1}},
    { text:"í•„ìš”í•˜ì§€ ì•Šìœ¼ë©´ ì›¬ë§Œí•˜ë©´ ì‚¬ì§€ ì•ŠëŠ”ë‹¤.", map:{S:1,G:0.5}},
    { text:"ê¸°ë¶„ì´ ì¢‹ì„ ë•Œ(ì„¤ë ˜) ë” ì‰½ê²Œ ê²°ì œí•œë‹¤.", map:{E:1,R:0.5}},
    { text:"ëˆì€ â€˜ë‚˜ë¥¼ ì‚´ë¦¬ëŠ” ê²ƒ(ê±´ê°•/ë°°ì›€/ì‹œê°„)â€™ì— ì“°ëŠ” ê²Œ ì•„ê¹ì§€ ì•Šë‹¤.", map:{G:1}},
    { text:"ì„¸ì¼/í•œì •/ì˜¤ëŠ˜ë§Œ ê°™ì€ ë§ì— ì•½í•œ í¸ì´ë‹¤.", map:{E:1,R:0.5}},
    { text:"ì†Œë¹„ ì „ì— ë¹„êµ/ê²€í† ë¥¼ ê¼¼ê¼¼íˆ í•œë‹¤.", map:{S:0.5,G:1}},
    { text:"ê³„íšëŒ€ë¡œ ì“°ì§€ ëª»í•˜ë©´ ë¶ˆì•ˆí•´ì§„ë‹¤.", map:{S:1}},
    { text:"ì†Œë¹„ëŠ” ë‚˜ì—ê²Œ â€˜ë³´ìƒâ€™ì´ ë  ë•Œê°€ ë§ë‹¤.", map:{R:1}},
    { text:"ì§€ë£¨í•˜ë©´ ì‡¼í•‘/ë°°ë‹¬ì•±ì„ ì¼ ë‹¤.", map:{E:1,R:0.5}},
    { text:"ëª©í‘œê°€ ìˆìœ¼ë©´ ì†Œë¹„ë„ ê·¸ ëª©í‘œì— ë§ì¶˜ë‹¤.", map:{G:1,S:0.5}},
  ];
  const typeName={R:"ğŸ’ ë³´ìƒí˜•",S:"ğŸŒ¿ ì•ˆì •í˜•",E:"ğŸŒŠ ê°ì •í˜•",G:"ğŸ¯ ëª©í‘œí˜•"};
  const typeDesc={
    R:"í”¼ê³¤/ìŠ¤íŠ¸ë ˆìŠ¤ ë•Œ ê²°ì œê°€ ëŠ˜ì–´ìš”. â€˜48ì‹œê°„ ë³´ë¥˜â€™ê°€ ì œì¼ ì˜ ë¨¹í˜€ìš”.",
    S:"ê³„íší˜• ê³µì£¼ë‹˜! ë‹¤ë§Œ í•„ìš” ì†Œë¹„ê¹Œì§€ ì–µëˆ„ë¥¼ ìˆ˜ ìˆì–´ìš”. ì˜ˆì‚° ì•ˆì´ë©´ OK.",
    E:"ê¸°ë¶„ì— ë”°ë¼ ì†Œë¹„ê°€ í”ë“¤ë ¤ìš”. ê°ì • TOPë§Œ ì¡ì•„ë„ í™• ì¢‹ì•„ì ¸ìš”.",
    G:"ëª©í‘œ ì¤‘ì‹¬ ê³µì£¼ë‹˜! íŠ¹ì • ì¹´í…Œê³ ë¦¬ ì ë¦¼ë§Œ ì ê²€í•˜ë©´ ì•ˆì •ì ì´ì—ìš”."
  };
  const qList=$("qList");
  questions.forEach((q,i)=>{
    const div=document.createElement("div");
    div.style.marginTop="10px";
    div.innerHTML = `
      <label>${i+1}. ${escapeHtml(q.text)}</label>
      <select data-q="${i}">
        ${[1,2,3,4,5].map(v=>`<option value="${v}" ${state.answers[i]==v?"selected":""}>${v}</option>`).join("")}
      </select>
    `;
    qList.appendChild(div);
  });
  qList.addEventListener("change",(e)=>{
    const sel=e.target, idx=Number(sel.dataset.q);
    if(Number.isFinite(idx)){ state.answers[idx]=Number(sel.value); save(); }
  });
  function calcType(){
    const scores={R:0,S:0,E:0,G:0};
    state.answers.forEach((ans,i)=>{
      const w=questions[i].map;
      for(const k of Object.keys(w)) scores[k]+=ans*w[k];
    });
    const pairs=Object.entries(scores).sort((a,b)=>b[1]-a[1]);
    return {scores, top1:pairs[0][0], top2:pairs[1][0]};
  }
  $("calcType").addEventListener("click",()=>{
    const {scores,top1,top2}=calcType();
    $("typeResult").innerHTML = `
      <div class="note">
        <div class="pill">ê³µì£¼ë‹˜ ê²°ê³¼</div>
        <div style="margin-top:8px;font-weight:900;font-size:16px;">${typeName[top1]} + ${typeName[top2]}</div>
        <div style="margin-top:8px;">ğŸ± ìš”ì • ì½”ë©˜íŠ¸: ${escapeHtml(typeDesc[top1])}</div>
        <div class="muted" style="margin-top:8px;">
          ${Object.entries(scores).map(([k,v])=>`${typeName[k]} ${v.toFixed(1)}`).join(" Â· ")}
        </div>
      </div>
    `;
    showFairyToast(`ğŸ± ê³µì£¼ë‹˜! <b>${typeName[top1]}</b> ê¸°ì§ˆì´ ê°•í•´ìš”.<br>${escapeHtml(typeDesc[top1])}`);
  });

  // log
  $("dDate").value=iso;

  $("addRow").addEventListener("click",()=>{
    const row={
      date:$("dDate").value||iso,
      item:($("dItem").value||"").trim()||"ê¸°íƒ€",
      amount:Number($("dAmount").value||0),
      category:$("dCategory").value,
      emotion:$("dEmotion").value,
      satis:Number($("dSatis").value),
      need:Number($("dNeed").value),
    };
    if(!row.amount || row.amount<=0){ alert("ê¸ˆì•¡ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”!"); return; }
    state.logs.unshift(row); save();
    const rs=regretScore(row.satis,row.need);
    showFairyToast(fairyCommentByScore(rs,row.category,row.emotion));
    $("dItem").value=""; $("dAmount").value="";
    renderLogs();
  });

  $("clearLogs").addEventListener("click",()=>{
    if(confirm("ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")){
      state.logs=[]; save(); renderLogs();
      showFairyToast("ğŸ§¼ ê³µì£¼ë‹˜, ê¸°ë¡ì„ ê¹¨ë—í•˜ê²Œ ì •ë¦¬í–ˆì–´ìš”!");
    }
  });

  function renderLogs(){
    const tb=$("logTbody"); tb.innerHTML="";
    state.logs.forEach((r,idx)=>{
      const rs=regretScore(r.satis,r.need);
      const high=rs>=6;
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${escapeHtml(r.date)}</td>
        <td>${escapeHtml(r.item)}</td>
        <td class="right">${formatWon(r.amount)}</td>
        <td>${escapeHtml(r.category??"-")}</td>
        <td>${escapeHtml(r.emotion??"-")}</td>
        <td>${r.satis} / ${r.need}</td>
        <td class="${high?"danger":"ok"}">${high?"ë†’ìŒ":"ë‚®ìŒ"} <span class="muted">(ì ìˆ˜ ${rs})</span></td>
        <td class="right"><button class="btn ghost" data-del="${idx}" type="button" style="padding:8px 10px;border-radius:14px;">ì‚­ì œ</button></td>
      `;
      tb.appendChild(tr);
    });
    tb.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click",()=>{
        const i=Number(btn.dataset.del);
        state.logs.splice(i,1); save(); renderLogs();
        showFairyToast("ğŸ± ì‚­ì œ ì™„ë£Œ! ê³µì£¼ë‹˜ ê¸°ë¡ ê¹”ë”~");
      });
    });
  }

  // report
  function buildMonthOptions(){
    const sel=$("monthSelect");
    const months=new Set();
    const nowMonth=iso.slice(0,7);
    months.add(nowMonth);
    state.logs.forEach(r=>{ const m=getYYYYMM(r.date); if(m) months.add(m); });
    const sorted=Array.from(months).sort().reverse();
    const prev=state.uiMonth||nowMonth;
    sel.innerHTML=sorted.map(m=>`<option value="${m}">${m}</option>`).join("");
    sel.value=sorted.includes(prev)?prev:nowMonth;
    state.uiMonth=sel.value; save();
    sel.onchange=()=>{ state.uiMonth=sel.value; save(); renderReport(); };
  }

  function renderReport(){
    buildMonthOptions();
    const selectedMonth=$("monthSelect")?.value||iso.slice(0,7);
    const logs=state.logs.filter(r=>getYYYYMM(r.date)===selectedMonth);

    const total=logs.reduce((a,r)=>a+r.amount,0);
    const avgSatis=logs.length?(logs.reduce((a,r)=>a+r.satis,0)/logs.length):0;
    const regretCnt=logs.filter(r=>regretScore(r.satis,r.need)>=6).length;
    const regretRate=logs.length?(regretCnt/logs.length)*100:0;

    const emoMap={}, catMap={};
    logs.forEach(r=>{ emoMap[r.emotion]=(emoMap[r.emotion]||0)+1; catMap[r.category]=(catMap[r.category]||0)+1; });
    const emoTop=Object.entries(emoMap).sort((a,b)=>b[1]-a[1])[0]?.[0] ?? "-";
    const catTop=Object.entries(catMap).sort((a,b)=>b[1]-a[1])[0]?.[0] ?? "-";

    $("kpis").innerHTML=`
      <div class="kpi"><div class="k">ì´ ì§€ì¶œ (${escapeHtml(selectedMonth)})</div><div class="v">${formatWon(total)}</div></div>
      <div class="kpi"><div class="k">í‰ê·  ë§Œì¡±ë„</div><div class="v">${avgSatis?avgSatis.toFixed(1):"-"}</div></div>
      <div class="kpi"><div class="k">í›„íšŒìœ¨(ë†’ìŒ)</div><div class="v">${logs.length?regretRate.toFixed(0)+"%":"-"}</div></div>
    `;

    $("emotionTop").innerHTML = logs.length
      ? `<span class="pill">TOP</span> <b>${escapeHtml(emoTop)}</b> (${emoMap[emoTop]}íšŒ) Â· ${logs.length}ê±´`
      : "ê¸°ë¡ì„ ì¶”ê°€í•˜ë©´ ë¶„ì„ë¼ìš”.";

    $("categoryTop").innerHTML = logs.length
      ? `<span class="pill">TOP</span> <b>${escapeHtml(catTop)}</b> (${catMap[catTop]}íšŒ) Â· ${logs.length}ê±´`
      : "ê¸°ë¡ì„ ì¶”ê°€í•˜ë©´ ë¶„ì„ë¼ìš”.";

    const lines=[];
    if(!logs.length){
      lines.push("ê³µì£¼ë‹˜! ì´ë²ˆ ë‹¬ ê¸°ë¡ì´ ì•„ì§ ì—†ì–´ìš”. ì†Œë¹„ 3ê±´ë§Œ ì ì–´ë„ ë¦¬í¬íŠ¸ê°€ ë§Œë“¤ì–´ì ¸ìš” ğŸ’—");
    } else {
      if(regretRate>=35) lines.push("ğŸ§¨ í›„íšŒìœ¨ì´ ë†’ì•„ìš” â†’ ë‹¤ìŒ ë‹¬ì€ â€˜48ì‹œê°„ ë³´ë¥˜ ê·œì¹™â€™ì„ ê¼­ ì ìš©í•´ìš”.");
      else if(regretRate<=10) lines.push("ğŸŒ¸ í›„íšŒìœ¨ì´ ë‚®ì•„ìš” â†’ ê³µì£¼ë‹˜ ì†Œë¹„ í†µì œë ¥ ë§Œë ™! ì§€ê¸ˆ ë¦¬ë“¬ ìœ ì§€í•´ìš”.");
      else lines.push("ğŸ¾ ê½¤ ì•ˆì •ì ì´ì—ìš” â†’ â€˜í›„íšŒ ì ìˆ˜ 6 ì´ìƒâ€™ë§Œ ì¤„ì—¬ë„ ì²´ê°ì´ ì»¤ìš”.");
      if(emoTop==="ìŠ¤íŠ¸ë ˆìŠ¤") lines.push("ğŸ§  ìŠ¤íŠ¸ë ˆìŠ¤ ì†Œë¹„ TOP â†’ ëˆ ëŒ€ì‹  í•  â€˜ëŒ€ì²´ í–‰ë™ 3ê°€ì§€â€™ë¥¼ ë¯¸ë¦¬ ì •í•´ë‘¬ìš”.");
      if(emoTop==="ì§€ë£¨í•¨") lines.push("ğŸ«§ ì§€ë£¨í•¨ ì†Œë¹„ TOP â†’ ì•± ì¼œê¸° ì „ì— 5ë¶„ë§Œ ì‚°ì±…/ì •ë¦¬!");
      if(emoTop==="ë¹„êµ") lines.push("ğŸª ë¹„êµ ì†Œë¹„ TOP â†’ SNS ë³´ê³  ê²°ì œëŠ” 24ì‹œê°„ ë³´ë¥˜ë§Œ í•´ë„ ê¸‰ê°í•´ìš”.");
      if(avgSatis && avgSatis<3) lines.push("ğŸ“‰ ë§Œì¡±ë„ê°€ ë‚®ì•„ìš” â†’ ë‹¤ìŒ ë‹¬ì€ â€˜ë§Œì¡± ë†’ì€ ì†Œë¹„(ê±´ê°•/íœ´ì‹/ë„êµ¬)â€™ ë¹„ìœ¨ì„ ëŠ˜ë ¤ìš”.");
    }
    $("strategy").innerHTML = lines.map(t=>`<div style="margin:6px 0;">${t}</div>`).join("");
  }

  // CSV (Excel-safe BOM)
  function toCsvValue(v){
    const s=String(v??"");
    if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }
  function downloadCsv(){
    const headers=["date","item","amount","category","emotion","satis","need"];
    const rows=state.logs.map(r=>[r.date,r.item,r.amount,r.category,r.emotion,r.satis,r.need]);
    const csv=[headers.join(","),...rows.map(row=>row.map(toCsvValue).join(","))].join("\n");
    const blob=new Blob(["\ufeff"+csv],{type:"text/csv;charset=utf-8;"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=`spend-fairy-${iso}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    showFairyToast("â¬‡ CSV ì €ì¥ ì™„ë£Œ! ê³µì£¼ë‹˜ ê¸°ë¡ì€ ì†Œì¤‘í•´ìš” ğŸ’—");
  }
  $("btnDownloadCsv").addEventListener("click", downloadCsv);

  // premium pdf button (locked)
  $("btnSavePdf").addEventListener("click", ()=>{
    showFairyToast("ğŸ”’ ë¦¬í¬íŠ¸ PDF ì €ì¥ì€ í”„ë¦¬ë¯¸ì—„ ì „ìš©ì´ì—ìš”, ê³µì£¼ë‹˜!");
    window.open(PAY_LINK, "_blank");
  });

  // reset all
  $("resetAll").addEventListener("click", ()=>{
    if(confirm("ì§„ë‹¨/ê¸°ë¡ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?")){
      localStorage.removeItem(KEY);
      location.reload();
    }
  });

  // initial
  renderLogs();
</script>
</body>
</html>
